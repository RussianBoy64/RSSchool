(()=>{"use strict";function e(e){return null!==e&&`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`}class t{constructor(){this.currentGameState={solvedState:null,currentState:null,moves:0,seconds:0,frameSize:4,isChanged:!1},this.savedGameState=null,this.isGameStarted=!1,this.timer=null,this.isSound=!0,this.dragData={isDragged:!1,startPageX:0,startPageY:0,gameBoard:null,tile:null,tileWidth:0,tileHeight:0,tileTransition:"",nullIdx:0,isNullOnRightSide:!1,isNullOnLeftSide:!1,isClickedAfterNull:!1,isClickedBeforeNull:!1,isClickedOverNull:!1,isClickedUnderNull:!1},this.results=[{name:"Vladimir",moves:15,seconds:123},{name:"Semen",moves:19,seconds:131},{name:"Arkadiy",moves:21,seconds:142},{name:"Vika",moves:23,seconds:145},{name:"Vitaliy",moves:29,seconds:232},{name:null,moves:null,seconds:null},{name:null,moves:null,seconds:null},{name:null,moves:null,seconds:null},{name:null,moves:null,seconds:null},{name:null,moves:null,seconds:null}]}setFrameSize(){const e=document.querySelector('.settings__input[name="frame-size"]:checked').value;this.currentGameState.frameSize=e}shuffle=e=>{e&&e.preventDefault(),this.stopGame(),this.setFrameSize();const t=document.querySelector(".backdrop"),a=document.querySelector(".settings"),s=document.querySelector(".settings__btn");s.classList.contains("active")&&(s.classList.remove("active"),a.classList.remove("show"),t.classList.remove("show"));const n=[],i=this.currentGameState.frameSize**2;for(let e=1;e<=i;e++)e===i?n.push(null):n.push(e);const r=function(e){const t=[].concat(e);for(let e=t.length-1;e>0;e--){let a=Math.floor(Math.random()*(e+1)),s=t[a];t[a]=t[e],t[e]=s}const a=function(e){const t=[].concat(e);let a=0,s=t.indexOf(null),n=Math.sqrt(t.length)-Math.floor(s/Math.sqrt(t.length));if(t.forEach(((e,t,s)=>{if(null!==e){let n=0;for(let i=t+1;i<s.length;i++)e>s[i]&&null!==s[i]&&(a++,n++)}})),t.length%2!=0&&a%2==0||t.length%2==0&&(n%2!=0&&a%2==0||n%2==0&&a%2!=0))return t;{let e=null;return null!==t[0]&&null!==t[1]?(e=t[1],t[1]=t[0],t[0]=e):(e=t[t.length-1],t[t.length-1]=t[t.length-2],t[t.length-2]=e),t}}(t);return a}(n);this.currentGameState.solvedState=n,this.currentGameState.currentState=r;const d=document.querySelector(".start__btn");this.renderGameBoard(),d.disabled&&d.removeAttribute("disabled")};renderGameBoard=()=>{const e=document.querySelector(".gameboard__gamefield");!1===this.isGameStarted&&e.classList.contains("show")&&e.classList.remove("show"),e.innerHTML="",this.currentGameState.currentState.forEach((t=>{const a=document.createElement("div"),s=100/this.currentGameState.frameSize+"%";a.classList.add("gamefield__tile"),null===t?(a.classList.add("empty"),a.textContent=""):a.textContent=t,a.style.width=s,a.style.height=s,e.append(a)})),!1===this.isGameStarted&&setTimeout((()=>{e.classList.add("show")}),0)};startGame=()=>{if(!1===this.isGameStarted){const e=document.querySelector(".start__btn"),t=document.querySelector(".save__btn");this.isGameStarted=!0,e.disabled=!0,t.disabled=!1,this.timer=setInterval(this.updateTime,1e3)}};stopGame=()=>{if(!0===this.isGameStarted){const t=document.querySelector(".stats__moves"),a=document.querySelector(".stats__time");this.isGameStarted=!1,this.currentGameState.moves=0,t.innerHTML="00",clearInterval(this.timer),this.currentGameState.seconds=0,a.textContent=e(this.currentGameState.seconds)}};saveGame=()=>{const e=document.querySelector(".load__btn"),t=JSON.stringify(this.currentGameState);this.savedGameState=JSON.parse(t),e.disabled=!1,localStorage.setItem("savedGameState",t)};saveGameData=()=>{localStorage.setItem("isSound",JSON.stringify(this.isSound)),localStorage.setItem("results",JSON.stringify(this.results))};addResults=e=>{e.preventDefault();const t=document.querySelector(".win__input").value,a=this.currentGameState.moves,s=this.currentGameState.seconds,n={position:null,name:t,moves:a,seconds:s},i=this.results.length;for(let e=0;e<i;e++){if(null===this.results[e].moves){n.position=e,this.results[e]=n;break}if(a<this.results[e].moves||a===this.results[e].moves&&s<this.results[e].seconds){n.position=e-1,this.results.splice(e,0,n),this.results.pop();break}}l.backdropHide(),this.shuffle()};loadGame=async()=>{const t=document.querySelector(".start__btn"),a=document.querySelector(".stats__moves"),s=document.querySelector(".stats__time"),n=JSON.parse(localStorage.getItem("savedGameState"));t.disabled=!1,this.isGameStarted=!1,this.currentGameState=n,this.renderGameBoard(),clearInterval(this.timer),a.innerHTML=String(this.currentGameState.moves).padStart(2,0),s.innerHTML=e(this.currentGameState.seconds)};updateTime=()=>{const t=document.querySelector(".stats__time");this.currentGameState.seconds++,t.innerHTML=e(this.currentGameState.seconds)};updateMoves=()=>{const e=document.querySelector(".stats__moves");this.currentGameState.moves++,e.innerHTML=String(this.currentGameState.moves).padStart(2,0)};boardClickHandler=e=>{const t=e.currentTarget;if(document.removeEventListener("mousemove",this.mouseMoveHandler),t.classList.contains("show")){const a=e.target,s=this.currentGameState.currentState.indexOf(null),n=s%this.currentGameState.frameSize!=this.currentGameState.frameSize-1,i=s%this.currentGameState.frameSize!=0,r=t.children[s].nextSibling===a,d=t.children[s].previousSibling===a,o=t.children[s-this.currentGameState.frameSize]===a,c=t.children[s+Number(this.currentGameState.frameSize)]===a,l=document.querySelector(".moveSound");this.startGame(),n&&r?(a.classList.add("moveLeft"),this.isSound&&l.play(),this.removeEventListeners(),t.addEventListener("animationend",this.changeGameState)):i&&d?(a.classList.add("moveRight"),this.isSound&&l.play(),this.removeEventListeners(),t.addEventListener("animationend",this.changeGameState)):o?(a.classList.add("moveDown"),this.isSound&&l.play(),this.removeEventListeners(),t.addEventListener("animationend",this.changeGameState)):c&&(a.classList.add("moveTop"),this.isSound&&l.play(),this.removeEventListeners(),t.addEventListener("animationend",this.changeGameState))}};mouseDownHandler=e=>{const t=e.currentTarget,a=e.target,s=a.offsetWidth,n=a.offsetHeight,i=window.getComputedStyle(a).transition,r=e.pageX,d=e.pageY,o=this.currentGameState.currentState.indexOf(null),c=o%this.currentGameState.frameSize!=this.currentGameState.frameSize-1,l=o%this.currentGameState.frameSize!=0,m=t.children[o].nextSibling===a,u=t.children[o].previousSibling===a,h=t.children[o-this.currentGameState.frameSize]===a,p=t.children[o+Number(this.currentGameState.frameSize)]===a;this.dragData.gameBoard=t,this.dragData.tile=a,this.dragData.tileWidth=s,this.dragData.tileHeight=n,this.dragData.tileTransition=i,this.dragData.startPageX=r,this.dragData.startPageY=d,this.dragData.nullIdx=o,this.dragData.isNullOnRightSide=c,this.dragData.isNullOnLeftSide=l,this.dragData.isClickedAfterNull=m,this.dragData.isClickedBeforeNull=u,this.dragData.isClickedOverNull=h,this.dragData.isClickedUnderNull=p,(c&&m||l&&u||h||p)&&(a.style.cursor="grabbing",a.style.transition="none",document.addEventListener("mousemove",this.mouseMoveHandler),t.removeEventListener("mousedown",this.mouseDownHandler))};mouseMoveHandler=e=>{if(1===e.buttons){const t=e.pageX,a=e.pageY,s=this.dragData.startPageX-t,n=this.dragData.startPageX-t>0,i=this.dragData.startPageX-t<0,r=Math.abs(s)<=this.dragData.tileWidth,d=this.dragData.startPageY-a,o=this.dragData.startPageY-a>0,c=this.dragData.startPageY-a<0,l=Math.abs(d)<=this.dragData.tileHeight;!1===this.dragData.isDragged&&(this.dragData.isDragged,this.dragData.gameBoard.removeEventListener("click",this.boardClickHandler),document.addEventListener("mouseup",this.mouseUpHandler)),this.startGame(),this.dragData.isNullOnRightSide&&this.dragData.isClickedAfterNull?n&&r&&(this.dragData.tile.style.transform=`translate(${-s}px, 0px)`):this.dragData.isNullOnLeftSide&&this.dragData.isClickedBeforeNull?r&&i&&(this.dragData.tile.style.transform=`translate(${-s}px, 0px)`):this.dragData.isClickedOverNull?c&&l&&(this.dragData.tile.style.transform=`translate(0px, ${-d}px)`):this.dragData.isClickedUnderNull&&o&&l&&(this.dragData.tile.style.transform=`translate(0px, ${-d}px)`)}};mouseUpHandler=e=>{const t=e.pageX,a=e.pageY,s=this.dragData.startPageX-t>0,n=this.dragData.startPageX-t<0,i=Math.abs(this.dragData.startPageX-t)>this.dragData.tileWidth/2,r=this.dragData.startPageY-a>0,d=this.dragData.startPageY-a<0,o=Math.abs(this.dragData.startPageY-a)>this.dragData.tileHeight/2,c=document.querySelector(".moveSound");this.dragData.isDragged,document.removeEventListener("mousemove",this.mouseMoveHandler),document.removeEventListener("mouseup",this.mouseUpHandler),this.dragData.tile.style.cursor="grab",this.dragData.tile.style.transition=this.dragData.tileTransition,this.dragData.isNullOnRightSide&&this.dragData.isClickedAfterNull?s&&i?(this.dragData.tile.classList.add("moveLeft"),this.isSound&&c.play(),this.removeEventListeners(),this.dragData.gameBoard.addEventListener("animationend",this.changeGameState)):this.moveBack():this.dragData.isNullOnLeftSide&&this.dragData.isClickedBeforeNull?n&&i?(this.dragData.tile.classList.add("moveRight"),this.isSound&&c.play(),this.removeEventListeners(),this.dragData.gameBoard.addEventListener("animationend",this.changeGameState)):this.moveBack():this.dragData.isClickedOverNull?d&&o?(this.dragData.tile.classList.add("moveDown"),this.isSound&&c.play(),this.removeEventListeners(),this.dragData.gameBoard.addEventListener("animationend",this.changeGameState)):this.moveBack():this.dragData.isClickedUnderNull&&(r&&o?(this.dragData.tile.classList.add("moveTop"),this.isSound&&c.play(),this.removeEventListeners(),this.dragData.gameBoard.addEventListener("animationend",this.changeGameState)):this.moveBack())};moveBack=()=>{const e=document.querySelector(".moveSound");this.dragData.tile.style.transform="translate(0px, 0px)",this.isSound&&e.play(),setTimeout((()=>{this.dragData.gameBoard.addEventListener("click",this.boardClickHandler),this.dragData.gameBoard.addEventListener("mousedown",this.mouseDownHandler)}),0)};changeGameState=e=>{const t=e.target,a=e.currentTarget,s=this.currentGameState.currentState.indexOf(+t.innerText),n=this.currentGameState.currentState.indexOf(null),i=this.currentGameState.currentState[s];this.currentGameState.currentState[s]=this.currentGameState.currentState[n],this.currentGameState.currentState[n]=i,this.renderGameBoard(),this.updateMoves(),t.className="gamefield__tile",this.addEventListeners(),this.isSolved()&&(a.classList.remove("show"),c.renderWin())};soundHandler=e=>{const t=e.target;this.isSound=t.checked};isSolved=()=>{const e=this.currentGameState.solvedState.join(" ")===this.currentGameState.currentState.join(" ");return e&&this.isSound&&document.querySelector(".victorySound").play(),e};removeEventListeners=()=>{const e=document.querySelector(".gameboard__gamefield"),t=document.querySelector(".shuffle__btn"),a=document.querySelector(".load__btn");e.removeEventListener("click",this.boardClickHandler),t.removeEventListener("click",this.shuffle),a.removeEventListener("click",this.loadGame)};addEventListeners=()=>{const e=document.querySelector(".gameboard__gamefield"),t=document.querySelector(".shuffle__btn"),a=document.querySelector(".load__btn");e.addEventListener("click",this.boardClickHandler),e.addEventListener("mousedown",this.mouseDownHandler),t.addEventListener("click",this.shuffle),a.addEventListener("click",this.loadGame)}}class a{constructor(){this.wrapper=null}createPopUpWrapper=async()=>{const e=document.createElement("div");return e.classList.add("popUp"),this.wrapper=e,e};renderResults=async()=>{const t=document.createElement("div"),a=document.createElement("h3");this.wrapper.innerHTML="",t.classList.add("results"),a.classList.add("results__title"),a.textContent="Top 10",t.append(a),o.results.forEach(((a,s)=>{const n=document.createElement("div");n.classList.add("row");const i=document.createElement("span");i.classList.add("position"),i.textContent=`${s+1}.`;const r=document.createElement("span");r.classList.add("name"),r.textContent=`${a.name||"..."}`;const d=document.createElement("span");d.classList.add("moves"),d.textContent=`M: ${a.moves||"00"}`;const o=document.createElement("span");o.classList.add("time"),o.textContent=`T: ${e(a.seconds)||"00:00"}`,n.append(i),n.append(r),n.append(d),n.append(o),t.append(n)})),this.wrapper.append(t),l.backdropShow(),setTimeout((()=>{this.wrapper.classList.add("show")}),0)};renderWin=async()=>{const t=document.createElement("div"),a=document.createElement("h3"),s=document.createElement("p"),n=document.createElement("form"),i=document.createElement("input"),r=document.createElement("button");t.classList.add("win"),a.classList.add("win__title"),a.textContent="Hooray!",s.classList.add("win__text"),s.textContent=`You solved the puzzle in ${e(o.currentGameState.seconds)} and ${o.currentGameState.moves} moves!`,n.classList.add("win__form"),n.action="/",i.classList.add("win__input"),i.placeholder="Your name",i.required=!0,i.maxLength=10,r.classList.add("btn"),r.classList.add("win__btn"),r.textContent="Save results",r.type="submit",clearInterval(o.timer),this.wrapper.innerHTML="",t.append(a),t.append(s),n.append(i),n.append(r),t.append(n),this.wrapper.append(t),l.backdropShow(),this.wrapper.classList.add("show"),n.addEventListener("submit",o.addResults)};popUpHide=()=>{this.wrapper.classList.remove("show")}}class s{constructor(){this.backdrop=null}createBackdrop=async()=>{const e=document.createElement("div");return e.classList.add("backdrop"),e.addEventListener("click",this.backdropHide),this.backdrop=e,e};backdropToggle=()=>{this.backdrop.classList.toggle("show")};backdropShow=()=>{this.backdrop.classList.add("show")};backdropHide=()=>{const e=document.querySelector(".win__input");(!e||e&&""!==e.value)&&(this.backdrop.classList.remove("show"),m.settingsMenuHide(),c.popUpHide())}}async function n(e="",t="",a=!1){const s=document.createElement("button");return s.classList.add("btn"),s.classList.add(e),s.textContent=t,s.disabled=a,s}const i=[{size:"3x3",value:3},{size:"4x4",value:4},{size:"5x5",value:5},{size:"6x6",value:6},{size:"7x7",value:7},{size:"8x8",value:8}];class r{constructor(){this.settings=null,this.settingsBtn=null}renderSettings=async()=>{const e=document.createElement("div"),t=document.querySelector(".settings__btn");e.classList.add("settings");const a=document.createElement("form"),s=document.createElement("span"),r=await n("shuffle__btn","Shuffle");a.classList.add("settings__form"),a.action="/",s.classList.add("settings__title"),s.textContent="Frame size:",a.append(s),i.forEach((e=>{const t=document.createElement("input"),s=document.createElement("label");t.classList.add("settings__input"),t.id=e.size,t.type="radio",t.name="frame-size",t.value=e.value,e.value===o.currentGameState.frameSize&&(t.checked=!0),s.classList.add("settings__label"),s.htmlFor=e.size,s.textContent=e.size,a.append(t),a.append(s)})),a.append(r);const d=document.createElement("input"),c=document.createElement("label");return d.classList.add("sound__input"),d.id="switch",d.type="checkbox",d.name="sound",d.checked=o.isSound,c.classList.add("sound__label"),c.htmlFor="switch",c.textContent="Sound",e.append(a),e.append(d),e.append(c),t.addEventListener("click",this.settingsMenuToggle),r.addEventListener("click",o.shuffle),d.addEventListener("change",o.soundHandler),this.settings=e,this.settingsBtn=t,e};settingsMenuToggle=()=>{this.settingsBtn.classList.toggle("active"),this.settings.classList.toggle("show"),c.wrapper.classList.contains("show")?c.wrapper.classList.remove("show"):l.backdropToggle()};settingsMenuHide=()=>{this.settingsBtn.classList.remove("active"),this.settings.classList.remove("show")}}function d(){const e=document.createElement("div");return e.classList.add("wrapper"),e}let o=null,c=null,l=null,m=null;const u=document.querySelector(".app");document.addEventListener("DOMContentLoaded",(async function(){o=await async function(){const e=new t,a=JSON.parse(localStorage.getItem("savedGameState")),s=localStorage.getItem("isSound"),n=JSON.parse(localStorage.getItem("results"));return a&&(e.savedGameState=a),s&&(e.isSound=JSON.parse(s)),n&&(e.results=n),e}(),c=new a,l=new s,m=new r;const e=await async function(){const e=document.createElement("header");e.classList.add("header");const t=d(),a=document.createElement("div");a.classList.add("header__inner");const s=document.createElement("div"),n=document.createElement("img"),i=document.createElement("h1");s.classList.add("header__logo"),n.src="./assets/logo.png",n.alt="app logo",i.textContent="Gem-puzzle";const r=document.createElement("i");return r.classList.add("fa-solid"),r.classList.add("fa-gear"),r.classList.add("settings__btn"),s.append(n),s.append(i),a.append(s),a.append(r),t.append(a),e.append(t),e}();u.append(e);const i=await async function(){const e=document.createElement("main");e.classList.add("main");const t=d();t.classList.add("gameboard");const a=document.createElement("div"),s=await n("shuffle__btn","Shuffle"),i=await n("start__btn","Start",!o.currentGameState.currentState),r=await n("results__btn","Results"),l=await n("save__btn","Save",!o.currentGameState.currentState),u=await n("load__btn","Load",!o.savedGameState);a.classList.add("gameboard__controls"),a.append(s),a.append(i),a.append(r),a.append(l),a.append(u);const h=await async function(){const e=document.createElement("span");return e.classList.add("gameboard__stats"),e.innerHTML='\n  <span>\n      <span class="stats__name">Moves:</span>\n      <span class="stats__moves">00</span>\n  </span>\n  <span>\n      <span class="span stats__name">Time:</span>\n      <span class="stats__time">\n        00: 00\n      </span>\n  </span>\n  ',e}(),p=document.createElement("div");p.classList.add("gameboard__gamefield");const g=await m.renderSettings(),S=document.createElement("audio"),v=document.createElement("source");S.classList.add("moveSound"),v.src="./assets/moveTile.mp3",v.type="audio/mpeg",S.append(v);const L=document.createElement("audio"),f=document.createElement("source");return L.classList.add("victorySound"),f.src="./assets/victory.mp3",f.type="audio/mpeg",L.append(f),t.append(a),t.append(h),t.append(p),e.append(t),e.append(g),e.append(S),e.append(L),s.addEventListener("click",o.shuffle),i.addEventListener("click",o.startGame),r.addEventListener("click",c.renderResults),l.addEventListener("click",o.saveGame),u.addEventListener("click",o.loadGame),p.addEventListener("click",o.boardClickHandler),p.addEventListener("mousedown",o.mouseDownHandler),e}();u.append(i);const h=await async function(){const e=document.createElement("footer");e.classList.add("footer");const t=d(),a=document.createElement("div");a.classList.add("author-info");const s=document.createElement("div"),n=document.createElement("a"),i=document.createElement("img");s.classList.add("author-info__item"),n.href="https://rs.school/js/",i.src="https://rs.school/images/rs_school_js.svg",i.alt="RS School",n.append(i),s.append(n);const r=document.createElement("div"),o=document.createElement("span");r.classList.add("author-info__item"),o.textContent="2022",r.append(o);const c=document.createElement("div"),l=document.createElement("div"),m=document.createElement("a"),u=document.createElement("i");return c.classList.add("author-info__item"),l.classList.add("github-link"),m.href="https://github.com/RussianBoy64",m.textContent="RussianBoy64",u.classList.add("fa-brands"),u.classList.add("fa-github"),u.classList.add("github-icon"),m.prepend(u),l.append(m),c.append(l),a.append(s),a.append(r),a.append(c),t.append(a),e.append(t),e}();u.append(h);const p=await l.createBackdrop();u.append(p);const g=await c.createPopUpWrapper();u.append(g),window.addEventListener("beforeunload",o.saveGameData)}))})();